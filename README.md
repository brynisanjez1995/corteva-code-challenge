# Weather Applciation

This application handles ingesting weather data, analyzing and summarizing the weather data 
and exposes REST API endpoints to search and view weather data and summary.

## Installation

- The app requires a PostgreSQL instance to connect to. Setup the database (e.g. using [docker](https://www.docker.com/blog/how-to-use-the-postgres-docker-official-image/))
- Create `weather` schema in the database
- Set following ENV vars for PostgresSQL connection
    - `DATABASE_NAME`
    - `DATABASE_USER`
    - `DATABASE_PASSWORD` (TODO - encrypt)
    - `DATABASE_HOST`
    - `DATABASE_PORT`
- Install dependencies: 
    - `cd src/weather`
    - `poetry install`
- Run DB migrations:
    - `python manage.py makemigrations`
    - `python manage.py migrate`
- Run the API server:
    - `python manage.py runserver`
- Ingest data:
    - Set the following ENV vars for input and output file dirs
      - `INPUT_PATH`
      - `PROCESSED_PATH`
    - `src/weather/scripts/ingest.py`
- Access endpoints:
    - `http://{host}:{port}/api/weather`
    - `http://{host}:{port}/api/weather/stats`
    - `http://{host}:{port}` (swagger endpoint)

## Test
- `cd src/weather`
- `python manage.py makemigrations`
- `python manage.py test`

## Deployment

Ideally, for production deployment to a cloud provider like `AWS`, we'll package the application into a docker image
and spawn a new EC2 instance to deploy the app. Overall, the following steps would be needed:
- Create a PostgreSQL instance using `Amazon RDS`
- Create a `Dockerfile` with instructions to build the application image
- Upload the image to `Amazon Elastic Container Registry`
- Spawn an `EC2` instance to deploy the image
- Configre load balancer to manage traffic across instances
- Use Amazon cloudwatch for monitoring
- Modify the ingestion script to read files from `Amazon S3` and schedule it using `AWS Lambda`


## Data Model

It uses two tables in `weather` schema (in a PostgreSQL database)

1. `daily_weather`

    - `id` (primary key)
    - `station_id` (text)
    - `date` (date)
    - `min_temp` (numeric - celcius)
    - `max_temp` (numeric - celcius)
    - `precipitation` (numeric - millimeters)

    `station_id_date_uk` unique contratint definies the combination of `station_id` and `date` as unique.

2. `yearly_weather_stats`

    - `id` (primary key)
    - `station_id` (text)
    - `year` (int8)
    - `avg_min_temp` (numeric - celcius)
    - `avg_max_temp` (numeric - celcius)
    - `total_precipitation` (centimeters)

    `station_id_year_uk` unique contratint definies the combination of `station_id` and `year` as unique.

- The data model is defined using `django` model classes in
`src/weather/api/weather_api/models.py`
- The SQL generated by `django` migrations are in `src/weather/api/weather_api/migrations`

## Ingestion

The `src/weather/scripts/ingest.py` handles ingestion of data into the `daily_weather` table, and analyzing and summarizing data into `yearly_weather_stats` table.

- It expects the following environment variables
  - `DATABASE_NAME`
  - `DATABASE_USER`
  - `DATABASE_PASSWORD` (TODO - encrypt)
  - `DATABASE_HOST`
  - `DATABASE_PORT`
  - `INPUT_PATH` (input files - each file's name is used as the `station_id`)
  - `PROCESSED_PATH` (the processed files are moved from `INPUT_PATH` to this location to make re-running easier in case of failure)
 - It loads the data into `daily_weather`, updating any duplicate records found. 
 - Then it aggregates data from `daily_weather` into `yearly_weather_stats` table, again updating any duplicate records
 - It can be run from the project root folder using `python src/weather/scripts/ingest.py`. And the logs are found in `logs/ingestion.log`

## REST API

It exposes the following endpoints
- `/api/weather` (List Weather)
- `/api/weather/stats` (Summarize Weather by Year)
- `/` - swagger doc

1. `/api/weather`
    - It allows following query params
        - `station_id`
        - `date`
    - Pagination can be achieved by using following query params
        - `offset`
        - `limit`
    - The response contains a JSON list of `weather` data. E.g.
    ```json
        {
            "count": 160,
            "next": "http://127.0.0.1:8000/api/weather/?date=1985-01-02&limit=10&offset=10",
            "previous": null,
            "results": [
                {
                    "id": 5575843,
                    "station_id": "USC00118740",
                    "date": "1985-01-02",
                    "min_temp": "-61.00",
                    "max_temp": "-122.00",
                    "precipitation": "0.00"
                },
                ...
        }
    ```

2. `/api/weather/stats`

    - It allows following query params
        - `station_id`
        - `year`
    - Pagination can be achieved by using following query params
        - `offset`
        - `limit`
    - The response contains a JSON list of `weather` summary data per year. E.g.
    ```json
        {
            "count": 166,
            "next": "http://127.0.0.1:8000/api/weather/stats?limit=10&offset=10&year=1995",
            "previous": null,
            "results": [
                {
                    "id": 19300,
                    "station_id": "USC00127482",
                    "year": 1995,
                    "avg_min_temp": "148.86",
                    "avg_max_temp": "44.14",
                    "total_precipitation": "925.40"
                }   ,
                ...
        }
    ```

